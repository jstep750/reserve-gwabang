<!DOCTYPE html>
<html lang="en">

<head>
    <title>마이페이지-Shift</title>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <!-- Font Awesome -->
  <link rel="stylesheet" href="https://use.fontawesome.com/releases/v5.11.2/css/all.css">
  <!-- Bootstrap core CSS -->
  <link href="css/bootstrap.min.css" rel="stylesheet">
  <!-- Material Design Bootstrap -->
  <link href="css/mdb.min.css" rel="stylesheet">
  <!-- Your custom styles (optional) -->
  <link href="css/style.min.css" rel="stylesheet">
  <link href="css/style.css" rel="stylesheet">
  <link rel="stylesheet" href="app.css">
  <script src="https://code.jquery.com/jquery-2.2.4.min.js" integrity="sha256-BbhdlvQf/xTY9gja0Dq3HiwQF8LaCRTXxZKRutelT44="
crossorigin="anonymous"></script>
<script src='https://cdnjs.cloudflare.com/ajax/libs/Chart.js/2.1.4/Chart.bundle.min.js'></script>

  <style>
 
       
  </style>
  
    <script>
      $(document).ready(function() {  
        function toggleNavbarMethod() {  
            if ($(window).width() > 768) {  
                $('.navbar .dropdown').on('mouseover', function(){  
                    $('.dropdown-toggle', this).trigger('click');   
                }).on('mouseout', function(){  
                    $('.dropdown-toggle', this).trigger('click').blur();  
                });  
            }  
            else {  
                $('.navbar .dropdown').off('mouseover').off('mouseout');  
            }  
        }  
        toggleNavbarMethod();  
        $(window).resize(toggleNavbarMethod);  
    }); 
  
  </script>
</head>



<body >
    <!-- Navbar -->
    
    <nav class="navbar fixed-top bg-white navbar-expand-lg navbar-light white scrolling-navbar">
      <div class="container">
        <a class="navbar-brand mr-5" href="#" target="_blank">
          <img
          src="img\shift\shift_logo.png"
          height="30"
          alt=""
          loading="lazy"
          width="50vw"
        />
        </a>
      
       <button class="navbar-toggler" type="button" data-toggle="collapse" data-target="#main_nav">
         <span class="navbar-toggler-icon"></span>
       </button>
       <div class="collapse navbar-collapse" id="main_nav">
     
     <ul class="navbar-nav mr-auto">
       <li class="nav-item dropdown"> <a class="nav-link font-weight-bold" data-toggle="dropdown" role="button" aria-expanded="false" href="#">쉬프트란</a>
        <ul class="dropdown-menu" style="">
          <li><a class="dropdown-item" style="font-size: 14px;" href="instruct_user.html"> 서비스 소개</a></li>
          
        </ul> <!-- 이거 border 왼쪽 오른쪽 중에 뭐가 더 나은지....-->
       </li>
       <li class="nav-item dropdown"><a class="nav-link font-weight-bold" data-toggle="dropdown" role="button" aria-expanded="false" href="#">옥션</a>
        <ul class="dropdown-menu">
          <li><a class="dropdown-item" href="#"> 진행중 옥션</a></li>
          <li><a class="dropdown-item" href="#"> 대기중 옥션 </a></li>
          <div></div>
        </ul>
      </li>
      
       
     </ul>
     <div class="navbar-nav" role="button" style="font-size: small;">
        <li class="nav-item dropdown"> <a class="nav-link font-weight-bold" data-toggle="dropdown" role="button" aria-expanded="false" href="#">회원</a>
            <ul class="dropdown-menu" style="">
              <li><a class="dropdown-item" style="font-size: 14px;" href="mypagemain.html"> 마이 페이지</a></li>
              <li><a class="dropdown-item" style="font-size: 14px;" href="myportfolio.html"> 마이 포트폴리오 </a></li>
              <li><a class="dropdown-item" style="font-size: 14px;" href="#"> 쉬프팅 머니 충전 </a></li>
              <li><a class="dropdown-item" style="font-size: 14px;" href="#"> 개인정보 관리 </a></li>
              <li><a class="dropdown-item" style="font-size: 14px;" onclick="logout();"> 로그아웃 </a></li>
              <div></div>
            </ul> <!-- 이거 border 왼쪽 오른쪽 중에 뭐가 더 나은지....-->
           </li>
       <a type="" class="nav-item nav-link mr-1" style="padding-left: 6px;" href="#">고객센터</a>
       <a class="btn-lg" style="color: #B1B1B1; padding: 2px; padding-left: 6px;" role="button" href="#"><i class="far fa-bell"></i></a>
     </div>
       </div> <!-- navbar-collapse.// -->
      </div>
      
     </nav>
  <!-- Navbar -->   

  <!--Main layout-->
  <main class="mt-4 pt-4">
    <div class="container mt-4" style="position: relative; min-height: 100vh; background-color: #fff;">
        <div class="row">
          <div class="sidebar">
            <ul class="nav nav-sidebar">
                <li class="font-weight-bold" style="font-size: 24px;color: #454545;margin-bottom: 80px;">마이페이지</li>
                <li class="mb-2"><a href="mypagemain.html" style="color: #222222;">마이페이지 홈</a></li>
                <li class="pb-1" style=""><a class="mypage-active" href="myportfolio.html" ">마이 포트폴리오</a></li>
              
            </ul>
            <hr class="my-1">
            <ul class="nav nav-sidebar mt-3" style="font-size: 14px;">
              <li class=""><div class="font-weight-bold mb-1" style="color: #454545;">마이 포트폴리오</div></li>
              <li class="" style="line-height: 1.7rem;">
                <a class="" style="color: #666666;" href="shiftmoney_status.html">머니 현황</a><br>
                <a class="" href="shiftmoney_paylist.html" style="color: #666666;">납부 예정 내역</a><br>
                <a href="shiftmoney_tax.html" style="color: #666666;">세금 조회</a><br>
                <a href="shiftmoney_depowith.html" style="color: #666666;">머니 충전 및 출금</a><br>
                <a href="shiftmoney_usermarket.html" style="color: #666666;">유저 마켓 신청 현황</a><br>
                
              </li>
              
            </ul>
            <ul class="nav nav-sidebar mt-3" style="font-size: 14px;">
              <li class=""><div class="font-weight-bold mb-1" style="color: #454545;">개인정보</div></li>
              <li class="pb-1" style="line-height: 1.7rem;"><a style="color: #666666;" href="private_admin.html">개인정보 관리</a><br>
                <a href="" style="color: #666666;">로그아웃</a><br>  
              </li> 
            </ul>
            <hr class="my-1">

        </div>
            <div class="col-sm-12 main mt-4">
                <h1 class="page-header mt-5 third_font mb-5">마이 포트폴리오</h1>
                <div class="container-fluid" style="padding: 0;">
                  <div class="row  d-flex align-items-center">
                    <div class="col-sm-8 col-md-6">
                      <div class="card" style="box-shadow: none;">
                          
                          <div class="card-body" style="height: auto">
                              <div class="chartjs-size-monitor" style="
                                  position: absolute;
                                  left: 0px; top: 0px; right: 0px; bottom: 0px;
                                  overflow: hidden;
                                  pointer-events: none;
                                  visibility: hidden;
                                  z-index: -1;">
                                  <div class="chartjs-size-monitor-expand" style="
                                      position:absolute;
                                      left:0;top:0;right:0;bottom:0;
                                      overflow:hidden;
                                      pointer-events:none;
                                      visibility:hidden;
                                      z-index:-1;">
                                      <div style="position:absolute;width:1000000px;height:1000000px;left:0;top:0"></div>
                                  </div>
                                  <div class="chartjs-size-monitor-shrink" style="position:absolute;left:0;top:0;right:0;bottom:0;overflow:hidden;pointer-events:none;visibility:hidden;z-index:-1;">
                                      <div style="position:absolute;width:200%;height:200%;left:0; top:0"></div>
                                  </div>
                              </div> <canvas id="chart-line" width="299" height="200" class="chartjs-render-monitor" style="display: block; width: 299px; height: 200px;"></canvas>
                              
                              <div id="getStock"></div>
                              <div id="test"></div>
                          </div>
                      </div>
                  </div>
                  <div class="col-md-6 col-sm-6" style="font-weight: 500;">
                    <div class="row">
                      <div class="col-12 thirdh4_font d-flex" style="margin-bottom: 8px;">
                        <div class="mr-3" style="width: 20px; height: 20px; background-color: #17375E;border-radius: 1rem;"></div>
                        <span class="mr-1">주식</span>
                        <span id="chart1"></span>
                      </div>
                      <div class="col-12 thirdh4_font d-flex" style="margin-bottom: 8px;">
                        <div class="mr-3" style="width: 20px; height: 20px; background-color: #367DD3;border-radius: 1rem;"></div>
                        <span class="mr-1">예수금</span>
                        <span id="chart2"></span>
                      </div>
                      <div class="col-12 thirdh4_font d-flex" style="margin-bottom: 8px;">
                        <div class="mr-3" style="width: 20px; height: 20px; background-color: #D4E8FF;border-radius: 1rem;"></div>
                        <span class="mr-1">거래대기금</span>
                        <span id="chart3"></span>
                      </div>
                    </div>
                  </div>
                  </div>
                    
                    
                </div>
                <div class="row align-items-stretch mt-3" style="padding: 30px; border: 1px solid #E5E5E5; border-radius: 1rem;">
                  <div class="col-md-4">
                    <div class="row" style="color: #757575;">
                      <div class="col-md-12 col-xs-6 col-sm-6" style="">
                        <p class="thirdh4_font font-weight-bold" style="margin-bottom: 0px;">출금 불가능 머니</p>
                        <p style="font-size: 10px;">이벤트 머니 + 거래대기금</p>
                      </div>
                      <div class="col-md-12 col-xs-6 col-sm-6 font-weight-bold" style="color: #17375E; font-size: 18px;">
                        <span id="impossibleCash">0</span>,000 원</div>
                    </div>
                  </div>
                  <div class="col-md-4">
                    <div class="row">
                      <div class="col-md-12 col-xs-6 col-sm-6" style="color: #757575;">
                        <p class="thirdh4_font font-weight-bold" style="margin-bottom: 0px;">거래대기금</p>
                        <p style="height: 15px;"></p>
                      </div>
                      <div class="col-md-12 col-xs-6 col-sm-6 font-weight-bold" style="color: #17375E; font-size: 18px;">
                        <span id="waitingCash">0</span>,000 원</div>
                      </div>
                    </div> 
                    <div class="col-md-4">
                      <div class="row" style="">
                        <div class="col-md-12 col-xs-6 col-sm-6" style="color: #757575;">
                          <p class="thirdh4_font font-weight-bold" style="margin-bottom: 0;">예수금</p>
                          <p style="height: 15px;"></p>
                        </div>
                        <div class="col-md-12 col-xs-6 col-sm-6 font-weight-bold" style="color: #17375E; font-size: 18px;">
                          <span id="userCash">0</span>,000 원</div>
                      </div>
                    </div>
                  </div>
                  
                  <div class="row align-items-stretch mt-3" style="padding: 30px; border: 1px solid #E5E5E5; border-radius: 1rem;">
                    <div class="col-md-4">
                      <div class="row" style="color: #757575;">
                        <div class="col-md-12 col-xs-6 col-sm-6 mb-2" style="">
                          <p class="thirdh4_font font-weight-bold" style="margin-bottom: 0px;">현재 주식 가격</p>
                          
                        </div>
                        <div class="col-md-12 col-xs-6 col-sm-6 font-weight-bold" style="color: #17375E; font-size: 18px;">
                          <span id="currentPrice">0</span>,000 원</div>
                      </div>
                    </div>
                    <div class="col-md-4">
                      <div class="row" style="">
                        <div class="col-md-12 col-xs-6 col-sm-6 mb-2" style="color: #757575;">
                          <p class="thirdh4_font font-weight-bold" style="margin-bottom: 0;">총 사용 금액</p>
                          
                        </div>
                        <div class="col-md-12 col-xs-6 col-sm-6 font-weight-bold" style="color: #17375E; font-size: 18px;">
                          <span id="userPrice">0</span>,000 원</div>
                      </div>
                    </div>
                    <div class="col-md-4">
                      <div class="row">
                        <div class="col-md-12 col-xs-6 col-sm-6 mb-2" style="color: #757575;">
                          <p class="thirdh4_font font-weight-bold" style="margin-bottom: 0px;">손익</p>
                        </div>
                        <div class="col-md-12 col-xs-6 col-sm-6 font-weight-bold" style="color: #17375E; font-size: 18px;">
                          <span id="userGain">0</span> %</div>
                        </div>
                      </div> 
                    </div>
                    <div class="mt-5 third_h4font" style="color: #454545;">
                      <p class="font-weight-bold">머니 이용안내</p>
                      <p class="mt-3 third_captionfont" style="color: #999999;">
                        다음 두 조건이 만족한 경우 출금 불가능한 머니의 총량이 줄어든다.<br>
                        1. 손해를 볼 경우<br>
                        2.손해를 볼 당시의 총 자산의 양이 이벤트 머니의 2배 이상일 경우<br><br>
                        해당 손해의 퍼센티지만큼 출금 불가능한 머니중 이벤트 머니가 줄어든다.
                      </p>
                    </div>
            </div>  
        </div>
    <div style="height: 100px;"></div>
  </main>
  <!--Main layout-->

  <!--Footer-->
  <footer class="page-footer text-center font-small" style="background-color: white; border-top: 1px solid grey;">
    <div style="height: 10px;"></div>
    <p class="mb-3" style="color: #333333;">Copyright © 2021 Shift</p>
    <p style="color: #333333;">상호: Shift | 대표: 김용운 | 개인정보관리책임자: 미입력 | 전화: 미입력 | 이메일: karlxyz99@korea.ac.kr</p>
    <div style="height: 3px;"></div>
  </footer>
  <!--/.Footer-->

  <!-- SCRIPTS -->
  <!-- JQuery -->

  <script type="text/javascript" src="js/jquery-3.4.1.min.js"></script>
  <!-- Bootstrap tooltips -->
  <script type="text/javascript" src="js/popper.min.js"></script>
  <!-- Bootstrap core JavaScript -->
  <script type="text/javascript" src="js/bootstrap.min.js"></script>
  <!-- MDB core JavaScript -->
  <script type="text/javascript" src="js/mdb.min.js"></script>
  <!--내가 추가한거 될지는 모르겠음-->
  <script type="text/javascript" src="js\userchartdata.js"></script>
  <!-- Initializations -->
  <script type="text/javascript">
  
  
    // Animations initialization
    new WOW().init();

  </script>

  <!-- The core Firebase JS SDK is always required and must be listed first -->
<script src="https://www.gstatic.com/firebasejs/8.2.2/firebase-app.js"></script>

<!-- TODO: Add SDKs for Firebase products that you want to use https://firebase.google.com/docs/web/setup#available-libraries -->
<script src="https://www.gstatic.com/firebasejs/8.2.2/firebase-analytics.js"></script>

<script src="https://www.gstatic.com/firebasejs/8.2.2/firebase-auth.js"></script>
<script src="https://www.gstatic.com/firebasejs/8.2.2/firebase-firestore.js"></script>
<script src="https://www.gstatic.com/firebasejs/8.2.2/firebase-database.js"></script>

<script>
var firebaseConfig = {
    apiKey: "AIzaSyCXRTprV0yWYk8YrVpopvkFM4Cv_Nmhb2g",
    authDomain: "shift-f80bc.firebaseapp.com",
    databaseURL: "https://shift-f80bc-default-rtdb.firebaseio.com",
    projectId: "shift-f80bc",
    storageBucket: "shift-f80bc.appspot.com",
    messagingSenderId: "111516463886",
    appId: "1:111516463886:web:f7ae7d49add43d4cc0dd5f",
    measurementId: "G-QXHD4RJNKQ"
};

// Initialize Firebase
firebase.initializeApp(firebaseConfig);

// Get a reference to the database service
var database = firebase.database();

firebase.auth().onAuthStateChanged(function(user) {
    if (user) {
      // User is signed in.
      //alert(user.displayName+"님 로그인");
      //document.getElementById("loginNav").textContent = "로그아웃";
      //document.getElementById('userName').textContent = user.displayName;
      var userId = user.uid;

      var messageRef = database.ref('user/'+userId+'/cash');
      var total1 = 0;
      messageRef.on('child_added', function(snapshot) {
          var data = snapshot.val();
          total1 += data;
          var updates = {};
          updates['user/'+userId+'/total_cash'] = total1;
          firebase.database().ref().update(updates);    
          document.getElementById('userCash').textContent = total1;
          //document.getElementById('addCash').textContent
          // = document.getElementById('waitingCash').textContent*1 + total1;
      });

      var messageRef = database.ref('user/'+userId+'/waiting_cash');
      var total2 = 0;
      messageRef.on('child_added', function(snapshot) {
          var data = snapshot.val();
          total2 += data;
          var updates = {};
          updates['user/'+userId+'/total_waiting_cash'] = total2;
          firebase.database().ref().update(updates);    
          document.getElementById('waitingCash').textContent = total2;
          document.getElementById('impossibleCash').textContent = 10 + total2;
          //document.getElementById('addCash').textContent
          //= document.getElementById('cash').textContent*1 + total2;
      });

      var messageRef = database.ref('user/'+ userId +'/game');
      messageRef.on('child_added', function(snapshot) {
          var gName = snapshot.key;
          var gPrice = 10;
          var gNum = 0;
          var total = 0;
          console.log(gName);
          firebase.database().ref('user/'+ userId +'/game/'+gName+'/num').once('value').then((snapshot1) => {
            firebase.database().ref('user/'+ userId +'/waiting_game/'+gName+'/num').once('value').then((snapshot2) => {
                gNum = snapshot1.val()*1 + snapshot2.val()*1;
                console.log(gNum);
                firebase.database().ref('game/'+ gName+ '/buy').orderByChild('price')
                .limitToLast(1).once('value').then((parentSnapshot) => {
                    if(parentSnapshot.exists()){
                        parentSnapshot.forEach(function (snapshot3) {
                            console.log(snapshot3.val());
                            gPrice = snapshot3.val().price;
                            total = gPrice*gNum;
                            document.getElementById('currentPrice').textContent
                            = document.getElementById('currentPrice').textContent*1 + total;
                            var a = document.getElementById('currentPrice').textContent*1;
                            var b = document.getElementById('userPrice').textContent*1;
                            document.getElementById('userGain').textContent = Math.round((a-b)/b*100);
                        });
                    }
                    else{
                      document.getElementById('currentPrice').textContent
                      = document.getElementById('currentPrice').textContent*1 + gPrice*gNum;
                      var a = document.getElementById('currentPrice').textContent*1;
                      var b = document.getElementById('userPrice').textContent*1;
                      document.getElementById('userGain').textContent = Math.round((a-b)/b*100);
                    }
                    var ctx = document.getElementById('chart-line'); 
                    var chart1 = document.getElementById('currentPrice').textContent*1;
                    var chart2 = document.getElementById('userCash').textContent*1;
                    var chart3 = document.getElementById('waitingCash').textContent*1;
                    var myChart = new Chart(ctx, {
                        type: 'doughnut',
                        data: {
                            labels: ["주식", "예수금", "거래대기금"],
                            datasets: [{
                                data: [chart1, chart2, chart3],
                                backgroundColor: ["#17375E", "#367DD3", "#D4E8FF"]
                            }]
                        },
                        options: {
                            title: {
                                display: true,
                                text: '상품별'
                            },
                            cutoutPercentage: 75,
                        }
                    });
                    var chartTotal = chart1+chart2+chart3;
                    document.getElementById('chart1').textContent = Math.round(chart1/chartTotal*100)+" %";
                    document.getElementById('chart2').textContent = Math.round(chart2/chartTotal*100)+" %";
                    document.getElementById('chart3').textContent = Math.round(chart3/chartTotal*100)+" %";
                    //document.getElementById('chart1').textContent = chart1+" 원";
                    //document.getElementById('chart2').textContent = chart2+" 원";
                    //document.getElementById('chart3').textContent = chart3+" 원";
                });
            });
          });

          var total1 = 0;
          firebase.database().ref('user/'+ userId +'/game/'+gName).on('child_added', function(snapshot1) {
              if(snapshot1.key != 'num'){
                  console.log(snapshot1.val());
                  total1 += snapshot1.val().number*snapshot1.val().price;
              }
              var total2 = 0;
              firebase.database().ref('user/'+ userId +'/waiting_game/'+gName).on('child_added', function(snapshot2) {
                  if(snapshot2.key != 'num'){
                      total2 += snapshot2.val().number*snapshot2.val().price;
                      document.getElementById('userPrice').textContent = total1 + total2;
                  }
              });
          });
      });
      //document.getElementById('email').value = user.email;
      //console.log(user)		// 인증 후 어떤 데이터를 받아오는지 확인해보기 위함.
      var db = firebase.firestore();
      var flag = true;
      var docRef = db.collection("user").doc(user.uid);
      docRef.get().then(function(doc) {
        if (doc.exists) {
            console.log("Document data:", doc.data()); 
            //window.location.href = "register_complete.html";
        } 
        else {
            db.collection("user").doc(user.uid).set({
                name: user.displayName,
                email: user.email,
                photoUrl: user.photoURL,
                emailVerified: user.emailVerified,
                account:"",
                uid: user.uid
            })
            .then(function() {
                console.log("Document successfully written!");
                alert(user.displayName+"님 회원가입 완료");
            })
            .catch(function(error) {
                console.error("Error writing document: ", error);
            });
        }
      }).catch(function(error) {
          console.log("Error getting document:", error);
      });
    } else {
      // No user is signed in.
      //alert("로그인 X");
      //console.log(user)		// 인증 후 어떤 데이터를 받아오는지 확인해보기 위함.
    }
});

function logout() {
  firebase.auth().signOut().then(function() {
    alert("로그아웃 성공");
    window.location.href = "loginpage.html";
  // Sign-out successful.
  }).catch(function(error) {
    alert("에러");
  // An error happened.
  });
}
</script>
</body>

</html>
